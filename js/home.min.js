function create_el(elementName = '', attributes = '') {
    var el = document.createElement(elementName);
    attributes = attributes.split(',');
    if (attributes != '') {
        for (var i in attributes) {
            var j = '';
            j = attributes[i];
            j = j.split('=');
            [key, val] = j;
            el.setAttribute(key, val);
        }
    }
    return el;
}
window.addEventListener('ready', loadContacts());
// window.addEventListener('SC')
function loadContacts() {

    fetch('./ajax/homePage.php').then(res => {
        return res.json();
    }).then(data => {
        // console.log(data);
        document.getElementsByClassName('chatbook_header')[0].children[0].children[0].src = './uploads/' + data['myData']['dp_src'] + '?v=15465';
        document.getElementsByClassName('chatbook_header')[0].children[1].children[0].innerHTML = data['myData']['name'];
        var contact_list = document.getElementById('contact_list');
        var searchResult = document.querySelector('.search_result');
        searchResult.innerHTML = '<p> Search Result</p><hr><p style="padding-top: 10px"> Contact Lists</p><hr><p></p>';
        searchResult.style.display = 'none';
        contact_list.innerHTML = '';

        for (i in data) {
            if (i == 'myData')
                continue;
            var contact_img = create_el('img', 'src=./uploads/' + data[i].dp_src);
            var contact_icon = create_el('div', 'class=contact_icon col-2,id=' + data[i].user_name + '_icon,onclick=display_image(this.children[0].src)');
            contact_icon.appendChild(contact_img);
            var title_node = document.createTextNode(data[i].name);
            var contact_title = create_el('div', 'class=contact_title col-8');
            contact_title.appendChild(title_node);
            var last_mess_time_node = document.createTextNode(data[i].mess_time);
            var last_mess_time = create_el('div', 'class=last_message_time col-4');
            last_mess_time.appendChild(last_mess_time_node);
            var last_mess_node = document.createTextNode(data[i].last_mess);
            var last_mess = create_el('div', 'class=col-10 last_message');
            // console.log(data[i].mess_time);// Shows online 
            if (data[i].mess_time.toLowerCase() == 'online') {
                last_mess_time.setAttribute('class', 'col-4 last_message_time online')
            }
            last_mess.appendChild(last_mess_node);
            var contact_detail = create_el('div', 'class=contact_detail col-10,id=' + data[i].user_name + '_detail,onclick=header(this)');
            contact_detail.appendChild(contact_title);
            contact_detail.appendChild(last_mess_time);
            contact_detail.appendChild(last_mess);
            var contact_div = create_el('div', 'class=contact col-12,id=' + data[i].user_name + '_' + data[i].name + '_user');
            contact_div.appendChild(contact_icon);
            contact_div.appendChild(contact_detail);
            if (data[i].new_mess > 0) {
                var new_mess_node = document.createTextNode(data[i].new_mess);
                var new_mess = create_el('div', 'class=col-1 mess_count');
                new_mess.appendChild(new_mess_node);
                contact_detail.appendChild(new_mess);
            }
            contact_list.appendChild(contact_div);
        }
        searchBoxCtrl();
        updateProfile();
        document.querySelector('.rightDiv').style.background = 'url(./uploads/' + username + '.jpg)';
    }).catch(error => {
        console.log(error);
    })
}

function backToContact() {
    if (window.screen.width < 900) {
        var contact_div = document.getElementById('contact_div');
        var rightDiv = document.getElementsByClassName('rightDiv')[0];
        contact_div.className = contact_div.className.replace(/(?!col-)\d+/, '12');
        rightDiv.className = rightDiv.className.replace(/(?!col-)\d+/, '0');
    }
}

function searchBoxCtrl() {
    searchBtn = document.getElementById('searchBtn');
    // addBtn = document.getElementById('addBtn');
    searchBox = document.getElementById('searchBox');
    searchBox.addEventListener('focusin', () => {
        searchBox.className = searchBox.className.replace(/(?!col-)\d+/, '8');
        searchBtn.className = searchBtn.className.replace(/(?!col-)\d+/, '4 ');


    })
    searchBox.addEventListener('focusout', () => {
        searchBox.className = searchBox.className.replace(/(?!col-)\d+/, '5');
        searchBtn.className = searchBtn.className.replace(/(?!col-)\d+/, '6 ');
    })
}

function updateProfile() {
    img = document.querySelector('html body div.bodyDiv.col-12 div.main_div div.chatbook_header div img');
    pIn = document.querySelector('#profileImg');
    pIn.addEventListener('change', () => {
        display_image(URL.createObjectURL(pIn.files[0]));
        var form = new FormData();
        form.append('img', pIn.files[0]);
        fetch('./ajax/profileUpdate.php', {
            method: 'post',
            body: form
        }).then(res => { return res.text() }).then(d => {
            console.log(d);
            img.src = d;
            window.location.reload();
        })
    })
}